default_platform(:ios)
KEYCHAIN_PASSWORD="Vedyo1234@"
CERTIFICATE_PASSWORD="Yellow59@"
owner_name="veda59-gmail.com"
app_name="vedcircleciproj"
project_name="vedtestprojecicd"
path = "./#{project_name}.xcodeproj"
platform :ios do
    before_all do
    setup_circle_ci
  end
  desc "Build app"
  lane :release do |options|
    begin
      setupCodeSigning(KEYCHAIN_PASSWORD, CERTIFICATE_PASSWORD, 'orgreactjsnativeexamplevedtestprojecicd_AppStore.mobileprovision', 'certificate.cer')

      cocoapods(clean_install: true, use_bundle_exec: false, error_callback: true)

      build_app(
        scheme: project_name, 
        configuration: 'Release'
      )

      upload_to_testflight(
        username: "veda59@gmail.com",
        skip_waiting_for_build_processing: true,
        skip_submission: true)

    rescue => exception
      #on_error(options[:slackUrl], "Build Failed", "#slack-channel", exception)
    end
  end
end


def setupCodeSigning(keychainPassword, certificatePassword, profilePath, certificatePath)
  create_keychain(
    name: "CI",
    password: keychainPassword,
    default_keychain: true,
    unlock: true,
    timeout: 3600,
    lock_when_sleeps: false
  )
  install_provisioning_profile(path: profilePath)
  import_certificate(
    certificate_path: certificatePath,
    certificate_password: certificatePassword,
    keychain_name: "CI",
    keychain_password: keychainPassword
  )
end
end
